# Ontology-aware query to trace a product batch through the supply chain
# This query uses the traceability ontology classes to find the complete trace

PREFIX trace: <http://provchain.org/trace#>
PREFIX prov: <http://www.w3.org/ns/prov#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

SELECT ?batch ?batchId ?activity ?activityType ?agent ?agentType ?timestamp ?conditions WHERE {
    # Find the target batch
    ?batch a trace:ProductBatch ;
           trace:hasBatchID ?batchId .
    
    # Find activities that used or generated this batch
    {
        ?activity prov:used ?batch .
    } UNION {
        ?batch prov:wasGeneratedBy ?activity .
    }
    
    # Get activity details
    ?activity a ?activityType ;
              trace:recordedAt ?timestamp .
    
    # Filter for ontology activity types
    FILTER(?activityType = trace:ProcessingActivity || 
           ?activityType = trace:TransportActivity || 
           ?activityType = trace:QualityCheck)
    
    # Find associated agents
    OPTIONAL {
        ?activity prov:wasAssociatedWith ?agent .
        ?agent a ?agentType .
        FILTER(?agentType = trace:Farmer || 
               ?agentType = trace:Manufacturer || 
               ?agentType = trace:LogisticsProvider || 
               ?agentType = trace:Retailer)
    }
    
    # Find environmental conditions if present
    OPTIONAL {
        ?activity trace:hasCondition ?condition .
        ?condition trace:hasTemperature ?temp ;
                   trace:hasHumidity ?humidity ;
                   trace:hasConditionTimestamp ?condTime .
        BIND(CONCAT("Temp: ", STR(?temp), "Â°C, Humidity: ", STR(?humidity), "%") AS ?conditions)
    }
    
    # Filter for a specific batch ID (change this value as needed)
    FILTER(?batchId = "UHT001")
}
ORDER BY ?timestamp
